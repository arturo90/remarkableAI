{% extends "base.html" %}

{% block title %}AI Results - RemarkableAI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">AI Analysis Results</h1>
                <p class="text-gray-600 mt-2">View insights extracted from your documents</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="refreshResults()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-refresh mr-2"></i>Refresh
                </button>
                <button onclick="exportResults()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-download mr-2"></i>Export
                </button>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-file-alt text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Documents Analyzed</p>
                    <p id="total-documents" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-tasks text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total Tasks</p>
                    <p id="total-tasks" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-calendar text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Dates Found</p>
                    <p id="total-dates" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-tags text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Topics</p>
                    <p id="total-topics" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <div class="flex space-x-4">
                <select id="document-filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Documents</option>
                </select>
                <select id="task-filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Tasks</option>
                    <option value="completed">Completed</option>
                    <option value="pending">Pending</option>
                </select>
            </div>
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search results..." 
                       class="border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-64">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
    </div>

    <!-- Content Tabs -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="border-b border-gray-200">
            <nav class="flex space-x-8 px-6" aria-label="Tabs">
                <button onclick="showTab('tasks')" id="tab-tasks" class="tab-button active py-4 px-1 border-b-2 border-blue-500 text-sm font-medium text-blue-600">
                    <i class="fas fa-tasks mr-2"></i>Tasks
                </button>
                <button onclick="showTab('summaries')" id="tab-summaries" class="tab-button py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-file-alt mr-2"></i>Summaries
                </button>
                <button onclick="showTab('dates')" id="tab-dates" class="tab-button py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-calendar mr-2"></i>Dates
                </button>
                <button onclick="showTab('topics')" id="tab-topics" class="tab-button py-4 px-1 border-b-2 border-transparent text-sm font-medium text-gray-500 hover:text-gray-700">
                    <i class="fas fa-tags mr-2"></i>Topics
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
            <!-- Tasks Tab -->
            <div id="tab-content-tasks" class="tab-content active">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Extracted Tasks</h3>
                    <div id="tasks-list" class="space-y-4">
                        <!-- Tasks will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Summaries Tab -->
            <div id="tab-content-summaries" class="tab-content hidden">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Document Summaries</h3>
                    <div id="summaries-list" class="space-y-6">
                        <!-- Summaries will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Dates Tab -->
            <div id="tab-content-dates" class="tab-content hidden">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Important Dates</h3>
                    <div id="dates-list" class="space-y-4">
                        <!-- Dates will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Topics Tab -->
            <div id="tab-content-topics" class="tab-content hidden">
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Key Topics</h3>
                    <div id="topics-list" class="space-y-4">
                        <!-- Topics will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let allResults = [];
let currentTab = 'tasks';

// Load results data
async function loadResults() {
    try {
        // For now, we'll load from the results directory
        // TODO: Create proper API endpoint for results
        const response = await fetch('/api/results/list');
        if (response.ok) {
            allResults = await response.json();
        } else {
            // Fallback: try to load from local storage results
            allResults = await loadResultsFromStorage();
        }
        
        updateStats();
        updateFilters();
        showCurrentTab();
        
    } catch (error) {
        console.error('Error loading results:', error);
        showNotification('Error loading results', 'error');
    }
}

// Load results from storage directory
async function loadResultsFromStorage() {
    try {
        const response = await fetch('/gmail/local/list-pdfs');
        const pdfs = await response.json();
        const results = [];
        
        for (const pdf of pdfs) {
            // Try to load corresponding result file
            try {
                const resultResponse = await fetch(`/api/results/${pdf.metadata.message_id}/${pdf.metadata.attachment_id}`);
                if (resultResponse.ok) {
                    const result = await resultResponse.json();
                    results.push({
                        ...result,
                        filename: pdf.filename,
                        metadata: pdf.metadata
                    });
                }
            } catch (error) {
                // Skip if no result file exists
            }
        }
        
        return results;
    } catch (error) {
        console.error('Error loading results from storage:', error);
        return [];
    }
}

// Update statistics
function updateStats() {
    const totalDocuments = allResults.length;
    const totalTasks = allResults.reduce((sum, result) => sum + (result.result.tasks?.length || 0), 0);
    const totalDates = allResults.reduce((sum, result) => sum + (result.result.dates?.length || 0), 0);
    const totalTopics = allResults.reduce((sum, result) => sum + (result.result.topics?.length || 0), 0);
    
    document.getElementById('total-documents').textContent = totalDocuments;
    document.getElementById('total-tasks').textContent = totalTasks;
    document.getElementById('total-dates').textContent = totalDates;
    document.getElementById('total-topics').textContent = totalTopics;
}

// Update filters
function updateFilters() {
    const documentFilter = document.getElementById('document-filter');
    const uniqueDocuments = [...new Set(allResults.map(r => r.filename || r.metadata?.subject || 'Unknown'))];
    
    documentFilter.innerHTML = '<option value="all">All Documents</option>';
    uniqueDocuments.forEach(doc => {
        documentFilter.innerHTML += `<option value="${doc}">${doc}</option>`;
    });
}

// Show tab content
function showTab(tabName) {
    currentTab = tabName;
    
    // Update tab buttons
    document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active', 'border-blue-500', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    document.getElementById(`tab-${tabName}`).classList.add('active', 'border-blue-500', 'text-blue-600');
    document.getElementById(`tab-${tabName}`).classList.remove('border-transparent', 'text-gray-500');
    
    // Update tab content
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
        content.classList.remove('active');
    });
    
    document.getElementById(`tab-content-${tabName}`).classList.remove('hidden');
    document.getElementById(`tab-content-${tabName}`).classList.add('active');
    
    showCurrentTab();
}

// Show current tab content
function showCurrentTab() {
    const documentFilter = document.getElementById('document-filter').value;
    const taskFilter = document.getElementById('task-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    
    const filteredResults = allResults.filter(result => {
        const matchesDocument = documentFilter === 'all' || 
            (result.filename && result.filename.includes(documentFilter)) ||
            (result.metadata?.subject && result.metadata.subject.includes(documentFilter));
        
        const matchesSearch = !searchTerm || 
            (result.result.summary && result.result.summary.toLowerCase().includes(searchTerm)) ||
            (result.result.tasks && result.result.tasks.some(task => task.toLowerCase().includes(searchTerm)));
        
        return matchesDocument && matchesSearch;
    });
    
    switch (currentTab) {
        case 'tasks':
            showTasks(filteredResults, taskFilter);
            break;
        case 'summaries':
            showSummaries(filteredResults);
            break;
        case 'dates':
            showDates(filteredResults);
            break;
        case 'topics':
            showTopics(filteredResults);
            break;
    }
}

// Show tasks
function showTasks(results, taskFilter) {
    const tasksList = document.getElementById('tasks-list');
    const allTasks = [];
    
    results.forEach(result => {
        if (result.result.tasks) {
            result.result.tasks.forEach(task => {
                allTasks.push({
                    task,
                    document: result.filename || result.metadata?.subject || 'Unknown',
                    date: result.processed_at || 'Unknown',
                    confidence: result.result.confidence || 0.8
                });
            });
        }
    });
    
    if (allTasks.length === 0) {
        tasksList.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-tasks text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No tasks found</h3>
                <p class="text-gray-500">Process some PDFs to extract tasks.</p>
            </div>
        `;
        return;
    }
    
    tasksList.innerHTML = allTasks.map(task => `
        <div class="flex items-start space-x-4 p-4 border rounded-lg hover:bg-gray-50">
            <div class="flex-shrink-0">
                <input type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900">${task.task}</p>
                <div class="flex items-center space-x-4 mt-1">
                    <span class="text-xs text-gray-500">From: ${task.document}</span>
                    <span class="text-xs text-gray-500">${task.date}</span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        ${Math.round(task.confidence * 100)}% confidence
                    </span>
                </div>
            </div>
        </div>
    `).join('');
}

// Show summaries
function showSummaries(results) {
    const summariesList = document.getElementById('summaries-list');
    
    if (results.length === 0) {
        summariesList.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-file-alt text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No summaries found</h3>
                <p class="text-gray-500">Process some PDFs to generate summaries.</p>
            </div>
        `;
        return;
    }
    
    summariesList.innerHTML = results.map(result => `
        <div class="border rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h4 class="text-lg font-medium text-gray-900">${result.filename || result.metadata?.subject || 'Unknown Document'}</h4>
                <span class="text-sm text-gray-500">${result.processed_at || 'Unknown date'}</span>
            </div>
            <p class="text-gray-700 leading-relaxed">${result.result.summary || 'No summary available'}</p>
            <div class="mt-4 flex items-center space-x-4">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    ${Math.round((result.result.confidence || 0.8) * 100)}% confidence
                </span>
                <span class="text-xs text-gray-500">Method: ${result.result.method || 'AI Analysis'}</span>
            </div>
        </div>
    `).join('');
}

// Show dates
function showDates(results) {
    const datesList = document.getElementById('dates-list');
    const allDates = [];
    
    results.forEach(result => {
        if (result.result.dates) {
            result.result.dates.forEach(date => {
                allDates.push({
                    date,
                    document: result.filename || result.metadata?.subject || 'Unknown',
                    context: result.result.summary || 'No context available'
                });
            });
        }
    });
    
    if (allDates.length === 0) {
        datesList.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-calendar text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No dates found</h3>
                <p class="text-gray-500">Process some PDFs to extract dates.</p>
            </div>
        `;
        return;
    }
    
    datesList.innerHTML = allDates.map(dateItem => `
        <div class="flex items-center space-x-4 p-4 border rounded-lg">
            <div class="flex-shrink-0">
                <div class="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar text-blue-600"></i>
                </div>
            </div>
            <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-gray-900">${dateItem.date}</p>
                <p class="text-sm text-gray-500">From: ${dateItem.document}</p>
                <p class="text-xs text-gray-400 mt-1 truncate">${dateItem.context}</p>
            </div>
        </div>
    `).join('');
}

// Show topics
function showTopics(results) {
    const topicsList = document.getElementById('topics-list');
    const allTopics = [];
    
    results.forEach(result => {
        if (result.result.topics) {
            result.result.topics.forEach(topic => {
                allTopics.push({
                    topic,
                    document: result.filename || result.metadata?.subject || 'Unknown',
                    frequency: 1 // TODO: Calculate actual frequency
                });
            });
        }
    });
    
    if (allTopics.length === 0) {
        topicsList.innerHTML = `
            <div class="text-center py-8">
                <i class="fas fa-tags text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No topics found</h3>
                <p class="text-gray-500">Process some PDFs to extract topics.</p>
            </div>
        `;
        return;
    }
    
    // Group topics by frequency
    const topicCounts = {};
    allTopics.forEach(item => {
        topicCounts[item.topic] = (topicCounts[item.topic] || 0) + 1;
    });
    
    const sortedTopics = Object.entries(topicCounts)
        .sort(([,a], [,b]) => b - a)
        .map(([topic, count]) => ({ topic, count }));
    
    topicsList.innerHTML = sortedTopics.map(topicItem => `
        <div class="flex items-center justify-between p-4 border rounded-lg">
            <div class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                    <i class="fas fa-tag text-purple-600 text-sm"></i>
                </div>
                <span class="text-sm font-medium text-gray-900">${topicItem.topic}</span>
            </div>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                ${topicItem.count} occurrence${topicItem.count > 1 ? 's' : ''}
            </span>
        </div>
    `).join('');
}

// Refresh results
async function refreshResults() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Refreshing...';
        button.disabled = true;
        
        await loadResults();
        showNotification('Results refreshed successfully', 'success');
    } catch (error) {
        console.error('Error refreshing results:', error);
        showNotification('Error refreshing results', 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Export results
function exportResults() {
    const dataStr = JSON.stringify(allResults, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(dataBlob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `remarkable-ai-results-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    URL.revokeObjectURL(url);
    
    showNotification('Results exported successfully', 'success');
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    loadResults();
    
    // Filter and search event listeners
    document.getElementById('document-filter').addEventListener('change', showCurrentTab);
    document.getElementById('task-filter').addEventListener('change', showCurrentTab);
    document.getElementById('search-input').addEventListener('input', showCurrentTab);
});
</script>

<style>
.tab-button.active {
    @apply border-blue-500 text-blue-600;
}

.tab-content.active {
    @apply block;
}
</style>
{% endblock %} 