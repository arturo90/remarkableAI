{% extends "base.html" %}

{% block title %}PDF Management - RemarkableAI{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">PDF Management</h1>
                <p class="text-gray-600 mt-2">Manage your PDF documents from Gmail</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="syncPdfs()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i>Sync from Gmail
                </button>
                <button onclick="processAllPdfs()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-magic mr-2"></i>Process All
                </button>
            </div>
        </div>
    </div>

    <!-- Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                    <i class="fas fa-file-pdf text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Total PDFs</p>
                    <p id="total-pdfs" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-green-100 text-green-600">
                    <i class="fas fa-check-circle text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Processed</p>
                    <p id="processed-pdfs" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                    <i class="fas fa-clock text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Pending</p>
                    <p id="pending-pdfs" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-md p-6">
            <div class="flex items-center">
                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                    <i class="fas fa-tasks text-xl"></i>
                </div>
                <div class="ml-4">
                    <p class="text-sm font-medium text-gray-600">Tasks Found</p>
                    <p id="total-tasks" class="text-2xl font-bold text-gray-900">-</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
            <div class="flex space-x-4">
                <select id="status-filter" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">All Status</option>
                    <option value="processed">Processed</option>
                    <option value="pending">Pending</option>
                </select>
                <select id="sort-by" class="border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="date">Sort by Date</option>
                    <option value="name">Sort by Name</option>
                    <option value="size">Sort by Size</option>
                </select>
            </div>
            <div class="relative">
                <input type="text" id="search-input" placeholder="Search PDFs..." 
                       class="border border-gray-300 rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-64">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
        </div>
    </div>

    <!-- PDF List -->
    <div class="bg-white rounded-lg shadow-md">
        <div class="p-6 border-b border-gray-200">
            <h2 class="text-xl font-semibold text-gray-900">PDF Documents</h2>
        </div>
        <div id="pdf-list" class="divide-y divide-gray-200">
            <!-- Loading state -->
            <div class="p-6">
                <div class="animate-pulse space-y-4">
                    <div class="h-4 bg-gray-200 rounded w-3/4"></div>
                    <div class="h-4 bg-gray-200 rounded w-1/2"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let allPdfs = [];
let filteredPdfs = [];

// Load PDF data
async function loadPdfData() {
    try {
        const response = await fetch('/gmail/local/list-pdfs');
        const data = await response.json();
        
        allPdfs = data.pdfs.map(pdf => ({
            ...pdf,
            filename: pdf.pdf.split('/').pop(),
            status: 'pending', // We'll determine this based on results
            processed: false
        }));
        
        // Check which PDFs have been processed
        await checkProcessedStatus();
        
        updateStats();
        filterAndDisplayPdfs();
        
    } catch (error) {
        console.error('Error loading PDF data:', error);
        showNotification('Error loading PDFs', 'error');
    }
}

// Check which PDFs have been processed
async function checkProcessedStatus() {
    try {
        const resultsDir = 'storage/results';
        const response = await fetch('/api/results/list');
        if (response.ok) {
            const results = await response.json();
            const processedIds = new Set();
            
            results.forEach(result => {
                const key = `${result.message_id}_${result.attachment_hash}`;
                processedIds.add(key);
            });
            
            allPdfs.forEach(pdf => {
                const key = `${pdf.metadata.message_id}_${pdf.metadata.attachment_id}`;
                pdf.processed = processedIds.has(key);
                pdf.status = pdf.processed ? 'processed' : 'pending';
            });
        }
    } catch (error) {
        console.error('Error checking processed status:', error);
    }
}

// Update statistics
function updateStats() {
    const total = allPdfs.length;
    const processed = allPdfs.filter(pdf => pdf.processed).length;
    const pending = total - processed;
    
    document.getElementById('total-pdfs').textContent = total;
    document.getElementById('processed-pdfs').textContent = processed;
    document.getElementById('pending-pdfs').textContent = pending;
    document.getElementById('total-tasks').textContent = '-'; // TODO: Calculate from results
}

// Filter and display PDFs
function filterAndDisplayPdfs() {
    const statusFilter = document.getElementById('status-filter').value;
    const searchTerm = document.getElementById('search-input').value.toLowerCase();
    const sortBy = document.getElementById('sort-by').value;
    
    // Apply filters
    filteredPdfs = allPdfs.filter(pdf => {
        const matchesStatus = statusFilter === 'all' || pdf.status === statusFilter;
        const matchesSearch = pdf.filename.toLowerCase().includes(searchTerm) || 
                            (pdf.metadata.subject && pdf.metadata.subject.toLowerCase().includes(searchTerm));
        return matchesStatus && matchesSearch;
    });
    
    // Apply sorting
    filteredPdfs.sort((a, b) => {
        switch (sortBy) {
            case 'name':
                return a.filename.localeCompare(b.filename);
            case 'size':
                return (a.metadata.size || 0) - (b.metadata.size || 0);
            case 'date':
            default:
                const dateA = a.metadata.date ? parseInt(a.metadata.date) : 0;
                const dateB = b.metadata.date ? parseInt(b.metadata.date) : 0;
                return dateB - dateA; // Newest first
        }
    });
    
    displayPdfs();
}

// Display PDFs in the list
function displayPdfs() {
    const pdfListElement = document.getElementById('pdf-list');
    
    if (filteredPdfs.length === 0) {
        pdfListElement.innerHTML = `
            <div class="p-12 text-center">
                <i class="fas fa-file-pdf text-4xl text-gray-300 mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No PDFs found</h3>
                <p class="text-gray-500">Try syncing from Gmail or adjusting your filters.</p>
            </div>
        `;
        return;
    }
    
    pdfListElement.innerHTML = filteredPdfs.map(pdf => {
        const date = pdf.metadata.date ? new Date(parseInt(pdf.metadata.date)).toLocaleDateString() : 'Unknown';
        const size = pdf.metadata.size ? formatFileSize(pdf.metadata.size) : 'Unknown';
        
        return `
            <div class="p-6 hover:bg-gray-50 transition-colors">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center">
                                <i class="fas fa-file-pdf text-red-600"></i>
                            </div>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h3 class="text-sm font-medium text-gray-900 truncate">${pdf.filename}</h3>
                            <p class="text-sm text-gray-500">${pdf.metadata.subject || 'No subject'}</p>
                            <div class="flex items-center space-x-4 mt-1">
                                <span class="text-xs text-gray-400">${date}</span>
                                <span class="text-xs text-gray-400">${size}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                    pdf.status === 'processed' 
                                        ? 'bg-green-100 text-green-800' 
                                        : 'bg-yellow-100 text-yellow-800'
                                }">
                                    ${pdf.status === 'processed' ? 'Processed' : 'Pending'}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        ${pdf.status === 'pending' ? `
                            <button onclick="processPdf('${pdf.metadata.message_id}', '${pdf.metadata.attachment_id}')" 
                                    class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-50">
                                <i class="fas fa-magic"></i>
                            </button>
                        ` : `
                            <button onclick="viewResults('${pdf.metadata.message_id}', '${pdf.metadata.attachment_id}')" 
                                    class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-50">
                                <i class="fas fa-eye"></i>
                            </button>
                        `}
                        <a href="/pdfs/${encodeURIComponent(pdf.filename)}" 
                           class="text-gray-600 hover:text-gray-800 p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-download"></i>
                        </a>
                        <button onclick="deletePdf('${pdf.filename}')" 
                                class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-50">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Sync PDFs from Gmail
async function syncPdfs() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Syncing...';
        button.disabled = true;
        
        const response = await fetch('/gmail/sync-pdfs', { method: 'POST' });
        const data = await response.json();
        
        if (response.ok) {
            showNotification(`Successfully synced ${data.count} PDFs`, 'success');
            await loadPdfData();
        } else {
            showNotification('Failed to sync PDFs: ' + data.detail, 'error');
        }
    } catch (error) {
        console.error('Error syncing PDFs:', error);
        showNotification('Error syncing PDFs', 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Process all PDFs
async function processAllPdfs() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    try {
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        button.disabled = true;
        
        const pendingPdfs = allPdfs.filter(pdf => !pdf.processed);
        
        if (pendingPdfs.length === 0) {
            showNotification('No PDFs to process', 'warning');
            return;
        }
        
        let processed = 0;
        for (const pdf of pendingPdfs) {
            try {
                const response = await fetch(`/gmail/local/process-with-ai/${pdf.metadata.message_id}/${pdf.metadata.attachment_id}`, {
                    method: 'POST'
                });
                if (response.ok) {
                    processed++;
                }
            } catch (error) {
                console.error('Error processing PDF:', error);
            }
        }
        
        showNotification(`Processed ${processed} out of ${pendingPdfs.length} PDFs`, 'success');
        await loadPdfData();
    } catch (error) {
        console.error('Error processing PDFs:', error);
        showNotification('Error processing PDFs', 'error');
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}

// Process individual PDF
async function processPdf(messageId, attachmentId) {
    try {
        const response = await fetch(`/gmail/local/process-with-ai/${messageId}/${attachmentId}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            showNotification('PDF processed successfully', 'success');
            await loadPdfData();
        } else {
            const data = await response.json();
            showNotification('Failed to process PDF: ' + data.detail, 'error');
        }
    } catch (error) {
        console.error('Error processing PDF:', error);
        showNotification('Error processing PDF', 'error');
    }
}

// View results
function viewResults(messageId, attachmentId) {
    // TODO: Navigate to results page
    showNotification('Results viewer coming soon!', 'info');
}

// Delete PDF
async function deletePdf(filename) {
    if (!confirm('Are you sure you want to delete this PDF?')) {
        return;
    }
    
    try {
        const response = await fetch(`/gmail/stored-pdfs/${encodeURIComponent(filename)}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            showNotification('PDF deleted successfully', 'success');
            await loadPdfData();
        } else {
            const data = await response.json();
            showNotification('Failed to delete PDF: ' + data.detail, 'error');
        }
    } catch (error) {
        console.error('Error deleting PDF:', error);
        showNotification('Error deleting PDF', 'error');
    }
}

// Show notification
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Event listeners
document.addEventListener('DOMContentLoaded', () => {
    loadPdfData();
    
    // Filter and search event listeners
    document.getElementById('status-filter').addEventListener('change', filterAndDisplayPdfs);
    document.getElementById('sort-by').addEventListener('change', filterAndDisplayPdfs);
    document.getElementById('search-input').addEventListener('input', filterAndDisplayPdfs);
});
</script>
{% endblock %} 